"use strict";var barChart=angular.module("barChart",[]);barChart.factory("d3",function(){return d3}),barChart.directive("barChart",["d3","globalData","sparqlQuery",function(t,e,r){function n(e,r,n,a){function u(t){return{Autores:"#807dba",Publicaciones:"#e08214",Salud:"#41ab5d"}[t]}function i(i){function o(e){$("h2.selected").text(""),$("h2.selected").text(e.ies);var n=r.filter(function(t){return e.hasOwnProperty("ies")?t.Source===e.ies:t.Source===e[0]})[0],a=t.keys(n.freq).map(function(t){return{type:t,freq:n.freq[t]}});d.update(a)}function c(t){$("h2.selected").text(""),$("h2.selected").text("Todas las Universidades"),d.update(s)}var l={},f={t:60,r:0,b:30,l:0};f.w=n-f.l-f.r,f.h=a-f.t-f.b;var p=e.append("svg").attr("width",f.w+f.l+f.r).attr("height",f.h+f.t+f.b).append("g").attr("transform","translate("+f.l+","+f.t+")"),h=t.scale.ordinal().rangeRoundBands([0,f.w],.1).domain(i.map(function(t){return t.ies})),m=t.scale.ordinal().domain(["publications","authors"]).rangeRoundBands([0,h.rangeBand()]);p.append("g").attr("class","x axis").attr("transform","translate(0,"+f.h+")").call(t.svg.axis().scale(h).orient("bottom"));var v=t.scale.linear().range([f.h,0]).domain([0,t.max(i,function(e){return t.max(e.values,function(t){return parseInt(t.value)})})]),b=p.selectAll(".bar").data(i).enter().append("g").attr("class","bar").attr("transform",function(t){return"translate("+h(t.ies)+",0)"});return b.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("x",function(t){return m(t.name)}).attr("y",function(t){return v(t.value)}).attr("width",m.rangeBand()).attr("height",function(t){return f.h-v(t.value)}).attr("fill",function(t){return u("authors"===t.name?"Autores":"Publicaciones")}).on("mouseover",o).on("mouseout",c),b.selectAll("div").data(function(t){return t.values}).enter().append("text").text(function(e){return t.format(",")(e.value)}).attr("x",function(t){return m(t.name)+m.rangeBand()/2}).attr("y",function(t){return v(t.value)-5}).attr("text-anchor","middle").style("font-size","70%"),l.update=function(e,r){if("undefined"!=typeof e[0]){v.domain([0,t.max(e,function(t){return t[1]})]);var n=p.selectAll(".bar").data(e);n.select("rect").transition().duration(500).attr("y",function(t){return v(t[1])}).attr("height",function(t){return f.h-v(t[1])}).attr("fill",r),n.select("text").transition().duration(500).text(function(e){return t.format(",")(e[1])}).attr("y",function(t){return v(t[1])-5})}},l}function o(r){function n(e,r){return t.format("%")(e.freq/t.sum(r.map(function(t){return t.freq})))}var a={},i=e.append("table").attr("class","legend"),o=i.append("tbody").selectAll("tr").data(r).enter().append("tr");return o.append("td").append("svg").attr("width","16").attr("height","16").append("rect").attr("width","16").attr("height","16").attr("fill",function(t){return u(t.type)}),o.append("td").text(function(t){return t.type}),o.append("td").attr("class","legendFreq").text(function(e){return t.format(",")(e.freq)}),a.update=function(e){var r=i.select("tbody").selectAll("tr").data(e);r.select(".legendFreq").text(function(e){return t.format(",")(e.freq)}),r.select(".legendPerc").text(function(t){return n(t,e)})},a}var c=e;c.html("");t.scale.ordinal().range(["#807dba","#41ab5d"]);r.forEach(function(t){t.total=0,t.total=parseInt(t.freq.Publicaciones)});var s=["Autores","Publicaciones"].map(function(e){return{type:e,freq:t.sum(r.map(function(t){return t.freq[e]}))}}),l=r.map(function(t){return{ies:t.Source,values:[{name:"publications",value:t.freq.Publicaciones,ies:t.Source},{name:"authors",value:t.freq.Autores,ies:t.Source}]}}),d=(i(l),o(s))}return{restrict:"E",scope:{data:"="},compile:function(e,r,a){var u=t.select(e[0]),i=parseInt(e.css("width")),o=(r.pcWidth?r.pcWidth:i,r.pcHeight,e.parent()[0].offsetWidth-.01*e.parent()[0].offsetWidth),c=2*o/7;return function(t,e,r){t.$watch("data",function(t,e,r){var a=r.data;a&&n(u,a,o,c)},!0)}}}}]);