"use strict";var explorableTree=angular.module("explorableTree",[]);explorableTree.factory("d3",function(){return d3}),explorableTree.directive("explorableTree",["d3","globalData","sparqlQuery","authorRestQuery","$window",function(e,t,a,r,n){var i=t.PREFIX+'CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}". ?subject rdfs:label ?name. ?subject foaf:img ?img .?subject uc:total ?totalPub } WHERE {  {    SELECT ?subject (MAX(str(?name_)) as ?name) (COUNT(DISTINCT ?relpublication) as ?totalPub) (MAX(str(?img_)) as ?imgm) (IRI (?imgm) as ?img)    WHERE {        GRAPH <'+t.clustersGraph+"> {          ?cluster foaf:publications ?publication .          ?publication uc:hasPerson <{1}> .          ?cluster foaf:publications ?relpublication .          ?relpublication uc:hasPerson ?subject .          {            SELECT ?name_ ?img_ {              GRAPH <"+t.centralGraph+"> {                 ?subject foaf:name ?name_ .                OPTIONAL{?subject  foaf:img ?img_. }              }            }          }          FILTER (?subject != <{1}>)        }    }    GROUP BY ?subject order by desc(?totalPub) limit 20  }}",o=t.PREFIX+'CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle;                                              uc:viewtitle "Authors Related With {0}".  ?subject rdfs:label ?name.  ?subject uc:total ?totalPub .  ?subject foaf:img ?img .} WHERE  {  SELECT ?subject (MAX(str(?name_)) as ?name) (COUNT( DISTINCT ?pub) as ?totalPub) (MAX(str(?img_)) as ?imgm) (IRI (?imgm) as ?img)  WHERE { GRAPH <'+t.centralGraph+"> {    <{1}> foaf:publications ?pub.    ?subject foaf:publications ?pub;             foaf:name ?name_.     OPTIONAL{?subject  foaf:img ?img_.}    FILTER(<{1}> != ?subject)  }} GROUP BY ?subject  order by desc(?totalPub) limit 20}",l=function(l,c,u,s,d){function f(){U.attr("transform","translate("+e.event.translate+")scale("+e.event.scale+")")}function p(e,r){a.querySrv({query:e},function(e){jsonld.compact(e,t.CONTEXT,function(e,t){var a=$("div.tree-node-author-info ."+r);if(a.html(""),t){var n=t["@graph"];if(n){var i=n.length?n:[n],o=$("<div>");a.append(o),i=_.sortBy(i,function(e){return e.hasOwnProperty("uc:total")?parseInt(e["uc:total"]["@value"]):-1}).reverse(),i=_.first(i,20),_.map(i,function(e){if(e["rdfs:label"]&&e["uc:total"]["@value"]){var t="string"==typeof e["rdfs:label"]?e["rdfs:label"]:_.first(e["rdfs:label"],1),a=$("<a class='relatedauthors' target='blank' onclick = 'return clickonRelatedauthor(\""+e["@id"]+"\")'  >").text(""),r=e["foaf:img"]?e["foaf:img"]["@id"]:"/wkhome/images/author-ec.png";return a.append('<img src="'+r+'" class="img-rounded" alt="Logo Cedia" width="20" height="20"        >'),a.append(t+"("+e["uc:total"]["@value"]+")"),o.append(a),o.append("</br>"),a}})}waitingDialog.hide()}waitingDialog.hide()})})}function h(e){var t=e.author["@id"],a=_.findWhere(e.author.jsonld["@graph"],{"@id":t,"@type":"foaf:Person"});if(a["foaf:name"]){var r=String.format(i,a["foaf:name"],t);p(r,"authorsByClusters");var n=String.format(o,a["foaf:name"],t);p(n,"authorsByPublications")}}function g(e){A=e;var t=H.scale(),a=-e.y0,r=-e.x0;a=a*t+q/2,r=r*t+G/2,l.select("g").transition().duration(I).attr("transform","translate("+a+","+r+")scale("+t+")"),H.scale(t),H.translate([a,r])}function b(e,o){var l=e.author["@id"],c={"foaf:name":{label:"Nombre:",containerType:"div"},"uc:fullName":{label:"Instituci√≥n: ",containerType:"div"},"uc:city":{label:"Ciudad: ",containerType:"div"},"uc:province":{label:"Provincia: ",containerType:"div"},"dct:subject":{label:"Subjects: ",containerType:"div"}},u=t.PREFIX+" CONSTRUCT   {      <"+l+"> foaf:name ?name;      uc:fullName ?provname;      uc:city ?city;      uc:province ?province;      dct:subject ?subjects  }  WHERE {      GRAPH <"+t.centralGraph+"> {          <"+l+"> foaf:name ?name;          dct:provenance ?provenance;          OPTIONAL {  <"+l+"> foaf:topic_interest [rdfs:label ?subjects]. }         {              SELECT DISTINCT ?provenance ?city ?provname ?province              WHERE             {                 graph <"+t.endpointsGraph+">                  {                      ?provenance uc:fullName ?provname.                     ?provenance uc:city ?city.                     ?provenance uc:province ?province.                 }             }         }       }   }  ",s=$("div.authorinfo");if(s.html(""),a.querySrv({query:u},function(e){jsonld.compact(e,t.CONTEXT,function(e,t){if(t["@graph"]){var a=t["@graph"][0];_.each(_.keys(c),function(e,t){if(a[e]){var r=$('<div class="explorableTree pubinfo"  style="background-color: #F7F8E0">'),n=$('<span class="label-author">').text(c[e].label);r.append(n),s.append(r);var i=a[e].length?a[e]:[a[e]];if("foaf:name"===e&&(i="string"==typeof i?i:_.first(i)),location.href.indexOf("/es/")!==-1&&"uc:fullName"===e?i=_.findWhere(a["uc:fullName"],{"@language":"es"})["@value"]:location.href.indexOf("/en/")!==-1&&"uc:fullName"===e&&(i=_.findWhere(a["uc:fullName"],{"@language":"en"})["@value"]),"string"==typeof i){var o=$('<span class="field-value">').text(i);r.append(o)}else _.map(i,function(e,t){if(t<=5){var a=$('<span class="field-value" style="font-size:70%">').text(e);r.append(a),r.append(", ")}})}}),s.append("<hr>")}})}),o){var l=e.author["@id"],f=_.findWhere(e.author.jsonld["@graph"],{"@id":l,"@type":"foaf:Person"});if(f["foaf:name"]){var p=String.format(i,f["foaf:name"],l);waitingDialog.show("Loading Authors Related with "+f["foaf:name"]),a.querySrv({query:p},function(e){jsonld.compact(e,t.CONTEXT,function(e,t){if(t){var a=t["@graph"];if(a){a.length?a:[a];d.ifrightClick({value:t})}waitingDialog.hide()}else waitingDialog.hide()})})}}else{var h=$("div.tree-node-info"),l=e.author["@id"],f=_.findWhere(e.author.jsonld["@graph"],{"@id":l,"@type":"foaf:Person"});if(!(f["@id"].indexOf(n.location.hostname)>0)&&e.author.jsonld["@graph"].length<=1){var g=f["@id"];waitingDialog.show("Searching publications of the external author");var b=t.PREFIX+"CONSTRUCT  { <"+g+"> ?propaut ?obbaut. ?obbaut ?propub ?objpub.    } WHERE{graph <"+t.externalAuthorsGraph+">        {<"+g+"> ?propaut ?obbaut.?obbaut ?propub ?objpub.}}";a.querySrv({query:b},function(a){jsonld.compact(a,t.CONTEXT,function(a,n){n["@graph"]?(e.author.jsonld["@context"]=_.extend(e.author.jsonld["@context"],t.CONTEXT),e.author.jsonld["@graph"]=_.flatten([e.author.jsonld["@graph"],n["@graph"]]),m("publication",e,e.author.jsonld,{"@type":"bibo:AcademicArticle"},t.CONTEXT,W),waitingDialog.hide()):r.query({resource:g},function(a){jsonld.compact(a,t.CONTEXT,function(a,r){if(r["@graph"]){e.author.jsonld["@context"]=_.extend(e.author.jsonld["@context"],t.CONTEXT),e.author.jsonld["@graph"]=_.flatten([e.author.jsonld["@graph"],r["@graph"]]),m("publication",e,e.author.jsonld,{"@type":"bibo:AcademicArticle"},t.CONTEXT,W),waitingDialog.hide()}else waitingDialog.hide(),alert("Papers not obtained for external author, you can try again")})})})}),h.append(anchor)}else{var v;if(e.author.jsonld["@graph"].length>1)v=e.author.jsonld,m("publication",e,v,{"@type":"bibo:AcademicArticle"},t.CONTEXT,W);else{var y=e.author["@id"],j=t.PREFIX+"CONSTRUCT {  <"+y+"> foaf:publications ?pub .  ?pub a bibo:AcademicArticle ;           dct:title ?title;}WHERE { GRAPH <"+t.centralGraph+"> {   <"+y+"> foaf:publications ?pub .  ?pub dct:title ?title.}}";a.querySrv({query:j},function(a){jsonld.compact(a,t.CONTEXT,function(a,r){e.author.jsonld["@context"]=_.extend(e.author.jsonld["@context"],t.CONTEXT),e.author.jsonld["@graph"]=_.flatten([e.author.jsonld["@graph"],r["@graph"]]),m("publication",e,e.author.jsonld,{"@type":"bibo:AcademicArticle"},t.CONTEXT,W)})})}}}}function m(e,t,a,r,n,i){t.children||(t.children=[]);var o;o="null"===r?a:_.where(a["@graph"],r),o.forEach(function(r){var o={};o[e]={"@id":r["@id"],jsonld:{"@context":n,"@graph":[r],"@id":a["@id"]}},o.children=null,t.children.push(o),i.push(r["@id"])}),R(t,!_.isEmpty(o)),g(t)}function v(e){var r=e.publication["@id"];if(r){var n=t.PREFIX+" construct { ?a a bibo:AcademicArticle . ?a ?b ?c .   ?c ?d ?e .   ?c ?p ?v . } where ";n+="{  graph <"+t.centralGraph+"> { bind (<"+r+"> as ?a) .   \t?a ?b ?c . filter (?b = dct:isPartOf || ?b = dct:subject || ?b = dct:publisher || ?b = dct:creator || ?b = dct:contributor || ?b = bibo:pages || ?b = bibo:issue || ?b = bibo:created || ?b = dct:title || ?b = bibo:abstract || ?b = bibo:uri || ?b = bibo:doi || ?b = <http://www.w3.org/1999/02/22-rdf-syntax-ns#type>   ) .  }  optional {  \tselect * {              ?c ?d ?e .              filter (?d = foaf:name ||                       ?d = <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> ||                       ?d = foaf:img ||                       ?d = rdfs:label                        ) .          }  }  optional {  \tselect * {               ?c <http://www.w3.org/2002/07/owl#sameAs> ?eq .              ?eq a <http://redi.cedia.edu.ec/ontology/journal> .              ?eq ?p ?v.               filter ( ?p=rdfs:label || ?p=bibo:uri || (?p=<http://www.w3.org/1999/02/22-rdf-syntax-ns#type> && ?v = bibo:Journal) ).           }  } }",waitingDialog.show("Searching ..."),a.querySrv({query:n},function(a){jsonld.compact(a,t.CONTEXT,function(a,r){waitingDialog.hide();var n=[],i={},o={},l=_.findWhere(r["@graph"],{"@type":"bibo:AcademicArticle"}),c=_.findWhere(r["@graph"],{"@type":"bibo:Journal"}),u=location.protocol+"//"+location.host+location.pathname+"resource?uri="+l["@id"]+"&format={0}",s=[{url:String.format(u,"application/rdf%2Bjson"),label:"RDF/JSON",img:"/wkhome/images/rdf-json.png"},{url:String.format(u,"application/rdf%2Bxml"),label:"RDF/XML",img:"/wkhome/images/rdf-xml.png"},{url:String.format(u,"text/turtle"),label:"Turtle",img:"/wkhome/images/turtle.png"},{url:String.format(u,"text/rdf%2Bn3"),label:"N3",img:"/wkhome/images/n3.png"},{url:String.format(u,"application/ld%2Bjson"),label:"JSON-LD",img:"/wkhome/images/json-ld.png"}],f=function(e){return"string"==typeof e?e:_.first(e)},p=function(e){var t="string"==typeof e?_.findWhere(r["@graph"],{"@id":e}):_.findWhere(r["@graph"],e),a={};a["@id"]=t["@id"],a["foaf:name"]=f(t["foaf:name"]),a["@type"]="foaf:Person",a["foaf:img"]=t["foaf:img"]?t["foaf:img"]:void 0,n.push(a)},h=function(e,t){var a;if("string"==typeof e)a=e,e={"@id":a};else{if("object"!=typeof e)return;a=e["@id"]}return a.indexOf("scholar.google.com")!==-1?(e.source="scholar",e.label="Google Scholar",e.img="/wkhome/images/scholar.png"):a.indexOf("academic.microsoft.com")!==-1?(e.source="academics",e.label="Academics Knowledge",e.img="/wkhome/images/academics.png"):a.indexOf("dblp.com")!==-1?(e.source="dblp",e.label="DBLP",e.img="/wkhome/images/dblp.png"):a.indexOf("scopus.com")!==-1?(e.source="scopus",e.label="Scopus",e.img="/wkhome/images/scopus.png"):a.indexOf("researchgate.net")!==-1?(e.source="research-gate",e.label="Research Gate",e.img="/wkhome/images/researchgate.png"):a.indexOf("latindex.org")!==-1?(e.source="latindex",e.label="Latindex",e.img="/wkhome/images/latindex.jpg"):a.indexOf("springer.com")!==-1?(e.source="springer",e.label="Springer",e.img="/wkhome/images/springer.png"):a.indexOf("pdf")!==-1?(e.source="pdf",e.label="PDF source",e.img="/wkhome/images/pdf.png"):(e.source="web",e.label="Web source",e.img="/wkhome/images/world.png"),e},g=function(e,t){try{var a=_.findWhere(r["@graph"],{"@id":e["@id"]});return a["rdfs:label"]}catch(n){return""}};i.id=l["@id"],i.title=f(l["dct:title"]),i["abstract"]=f(l["bibo:abstract"]),i.doi=f(l["bibo:doi"]),i.pages=f(l["bibo:pages"]),i.created=f(l["bibo:created"]),i.issue=f(l["bibo:issue"]),i.volume=f(l["bibo:volume"]),i.publisher=f(l["dct:publisher"]),i.uri=_.mapObject(l["bibo:uri"],h),i.subjects=_.mapObject(l["dct:subject"],g),c&&c["@id"]&&(o.id=c["@id"],o.journalName=f(c["rdfs:label"]),c["bibo:uri"]?(o.journalURL=f(c["bibo:uri"]["@id"]),o.journalProvenanceIcon=_.mapObject(c["bibo:uri"],h),o.journalProvenanceIcon["@id"]&&(o.journalProvenanceIcon=o.journalProvenanceIcon["@id"])):o.journalURL=o.id),_.each(l["dct:contributor"],p),_.each(l["dct:creator"],p),i.authors=_.uniq(n,function(e){return e["@id"]}),i.formats=s,d.publication=i,d.publication.journal=o,d.$apply(),m("author",e,{"@graph":_.without(i.authors,_.findWhere(n,{"@id":e.parent.author["@id"]}))},"foaf:Person",t.CONTEXT,X)})})}}function y(e){var t=e["@graph"][0]["@id"];return X.push(t),{author:{"@id":t,jsonld:e},children:null}}function j(e){return"author"in e}function x(e){return"publication"in e}function T(e){if(e.children&&e.children.forEach(function(e){T(e)}),j(e)){var t=X.indexOf(e.author.id);X.splice(t,1)}}function w(e){e.children.forEach(function(e){T(e)})}function E(e){return j(e)&&b(e,!0),e}function O(e){if(e.children){var t=$("div.tree-node-info .entityInfo");t.html("");var a=$("div.try-external-search .external-search-google");a.html("");var r=$("div.try-external-search .external-search-dblp");r.html("");var n=$("div.try-external-search .external-search-scopus");n.html(""),w(e),e.children=null,R(e,!1),g(e)}else j(e)?b(e,!1):x(e)&&v(e);return e}function P(e){e=O(e)}function R(t,a){var r=[1],n=function(e,t){t.children&&t.children.length>0&&(r.length<=e+1&&r.push(0),r[e+1]+=t.children.length,t.children.forEach(function(t){n(e+1,t)}))};n(0,k);var i=110*e.max(r);L=L.size([i,q]);var o=L.nodes(k).reverse(),l=L.links(o);o.forEach(function(e){e.y=220*e.depth});var c=U.selectAll("g.tree-node").data(o,function(e){return e.id||(e.id=++S)}),u=e.tip().attr("class","tree-d3-tip").html(function(e){return" "}),s=c.enter().append("g").call(a?u:function(){}).attr("class","tree-node").attr("transform",function(e){return"translate("+t.y0+","+t.x0+")"}).on("mouseover",function(e){var t=e;if("publication"in e){var a=e.publication["@id"],r=_.findWhere(t.publication.jsonld["@graph"],{"@id":a,"@type":"bibo:AcademicArticle"})["dct:title"];"string"!=typeof r&&(r=_.first(r)),u.html(r),u.show(e)}}).on("mouseout",function(e){"publication"in e&&u.hide(e),"author"in e&&u.hide(e)}).on("contextmenu",e.contextMenu(B,function(e){console.log("Quick! Before the menu appears!"),"author"in e||window.stop()})).on("click",P);s.append("circle").attr("r",32).style("fill",function(e){return e._children?"black":"#fff"}),D++,s.append("clipPath").attr("id","clipCircle"+D).append("circle").attr("r",32),s.append("image").attr("xlink:href",function(e){return j(e)?e.author.jsonld["@graph"][0]["foaf:name"]&&e.author.jsonld["@graph"][0]["foaf:img"]?e.author.jsonld["@graph"][0]["foaf:img"]["@id"]:e.author.jsonld["@graph"][0]["foaf:name"]&&e.author.jsonld["@graph"][0]["@id"].indexOf("localhost")>0?"wkhome/images/author-ec.png":"wkhome/images/author-default.png":"wkhome/images/document-default.png"}).attr("x","-32px").attr("y","-32px").attr("clip-path","url(#clipCircle"+D+")").attr("width",function(e){return 64}).attr("height",function(e){return 64}),s.append("text").attr("x",function(e){return-125}).attr("dy","40").attr("class","tree-nodeText").attr("text-anchor",function(e){return"start"}).text(function(e){if(j(e)){var t=e.author["@id"],a=_.findWhere(e.author.jsonld["@graph"],{"@id":t,"@type":"foaf:Person"}),r="string"==typeof a["foaf:name"]?a["foaf:name"]:_.first(a["foaf:name"]);return r}}).style("fill-opacity",0);var d=c.transition().duration(I).attr("transform",function(e){return"translate("+e.y+","+e.x+")"});d.select("text").style("fill-opacity",1);var f=c.exit().transition().duration(I).attr("transform",function(e){return"translate("+t.y+","+t.x+")"}).remove();f.select("circle").attr("r",0),f.select("text").style("fill-opacity",0);var p=U.selectAll("path.tree-link").data(l,function(e){return e.target.id});p.enter().insert("path","g").attr("class","tree-link").attr("d",function(e){var a={x:t.x0,y:t.y0};return F({source:a,target:a})}),p.transition().duration(I).attr("d",F),p.exit().transition().duration(I).attr("d",function(e){var a={x:t.x,y:t.y};return F({source:a,target:a})}).remove(),o.forEach(function(e){e.x0=e.x,e.y0=e.y})}var C=l;C.html("");var N,k,A,S=0,I=750,X=[],W=[],D=0,q=c,G=u,L=e.layout.tree().size([u,c]),F=e.svg.diagonal().projection(function(e){return[e.y,e.x]}),H=e.behavior.zoom().scaleExtent([.1,3]).on("zoom",f);l.attr("width",q).attr("height",G).attr("class","tree-overlay").call(H);var B=[{title:"Autores Relacionados",action:function(e,t,a){E(t)}}],U=l.append("g");X=[],k=y(s),k.x0=G/2,k.y0=0,N=k.author["@id"],h(k),R(k,!0),g(k),P(k)};return{restrict:"E",scope:{data:"=",publication:"=",ifrightClick:"&",clickonRelatedAuthor:"&"},compile:function(t,a,r){var n=$(t).width(),i=$(t).height(),o=e.select(t[0]).append("svg");return function(e,t,a){e.$watch("data",function(e,t,a){if(a.data&&a.data["@graph"]){var r=jQuery.extend({},a.data);l(o,n,i,r,a)}},!0)}}}}]);