"use strict";var cloudCluster=angular.module("cloudCluster",[]);cloudCluster.factory("d3",function(){return d3}),cloudCluster.directive("cloudCluster",["d3","sparqlQuery",function(t,n){function e(n,e,o){function l(n,e){for(var r=t.max(_.pluck(n,e)),a=n,i=0;i<n.length;i++)a[i].radius=""!=e?p*(n[i][e]/r):5,a[i].x=n[i].x?n[i].x:Math.random()*y,a[i].y=n[i].y?n[i].y:Math.random()*g;return a}function c(n){t.selectAll("circle").transition().style("fill",function(t){return"cluster"==n&&t?u[t.cluster]:u["default"]}).duration(100)}function d(t){"cluster"==t?(y=Math.max(.95*document.documentElement.clientWidth,.95*window.innerWidth||0),g=Math.max(document.documentElement.clientHeight+1*e.length-350,window.innerHeight+1*e.length-350||0),x.attr("width",y).attr("height",g)):(y=Math.max(.95*document.documentElement.clientWidth),g=Math.max(.8*document.documentElement.clientHeight),x.attr("width",y).attr("height",g));var n=M(t,[y,g]);H.on("tick",s(n,t)),h(n),H.start(),c(t)}function s(t,n){for(var e={},r=0;r<t.length;r++)e[t[r].name]=t[r];return function(t){for(var r=0;r<w.length;r++){var a=w[r],i=e[a[n]];a.y+=(i.y+i.dy/2-a.y)*t.alpha,a.x+=(i.x+i.dx/2-a.x)*t.alpha}E.each(v(.11)).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}}function h(t){x.selectAll(".label").remove(),x.selectAll(".label").data(t).enter().append("text").attr("class","label").attr("fill","red").text(function(t){if(null!=t.keyword&&("string"==typeof t.keyword||t.keyword instanceof String)&&null!=t.keyword.toString().trim()&&""!=t.keyword.toString().trim()){var n=t.keyword.toString().split(","),e=n.length>0&&n[0].length>1?n[0].trim().replace('"',"").substring(0,22):"";return e}return t.name}).attr("transform",function(t){return"translate("+(t.x+t.dx/2-40)+", "+(t.y+20)+")"})}function f(){$(".popover").each(function(){$(this).remove()})}function m(t){$(this).popover({placement:"auto top",container:"body",trigger:"manual",html:!0,content:function(){return"<b>Author:</b> "+t.author+"<br /><b>Keywords:</b> "+t.keyword+"<br /><b>Cluster:</b> "+t.clusterName+"<br />"}}),$(this).popover("show")}function v(n){var e=t.geom.quadtree(w);return function(t){var r=t.radius+b+k,a=t.x-r,i=t.x+r,u=t.y-r,o=t.y+r;e.visit(function(e,r,l,c,d){if(e.point&&e.point!==t){var s=t.x-e.point.x,h=t.y-e.point.y,f=Math.sqrt(s*s+h*h),m=t.radius+e.point.radius+k;f<m&&(f=(f-m)/f*n,t.x-=s*=f,t.y-=h*=f,e.point.x+=s,e.point.y+=h)}return r>i||c<a||l>o||d<u})}}var p=400,y=Math.max(1*document.documentElement.clientWidth,1*window.innerWidth),g=Math.max(1*document.documentElement.clientHeight,1*window.innerHeight),x=n.append("svg").attr("width",y).attr("height",g),w=l(e,i),k=8,b=t.max(_.pluck(w,"radius")),A=function(t){f(),r.$parent.clickonAuthor(t.idAuthor)},M=function(n,e){var r,a;return r=_.uniq(_.pluck(w,n)).map(function(t){var e="",r="";if("cluster"==n)for(var a=0,i=0;null!=t&&0==a&&null!=w[i];)w[i].cluster==t&&(e=w[i].keyword,null!=e&&""!=e||(e=w[i].clusterName),u[t]="#"+Math.floor(16777215*Math.random()).toString(16),a++),r=w[i].idAuthor,i++;return{name:t,value:1,keyword:e,id:r}}),a=t.layout.treemap().size(e).ratio(1),a.nodes({children:r}),r},E=x.selectAll("circle").data(w);E.enter().append("circle").attr("class","node").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.x}).attr("r",function(t){return t.radius}).style("fill",function(t,n){return u["default"]}).on("mouseover",function(t){m.call(this,t)}).on("mouseout",function(t){f()}).on("click",A),$("#group").change(function(){a=this.value,d(a)}),$("#size").change(function(){var n=this.value,e=t.max(_.pluck(w,n));t.selectAll("circle").data(l(w,this.value)).transition().attr("r",function(t,r){return n?p*(w[r][n]/e):15}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).duration(2e3),i=this.value,H.start()});var H=t.layout.force();d(o)}var r,a="",i="",u=new Array;return u["default"]="#5882FA",{restrict:"E",scope:{data:"="},compile:function(n,a,i){var u=parseInt(n.css("width")),o=parseInt(n.css("height")),l=(a.ctWidth?a.ctWidth:u,a.ctHeight?a.ctHeight:o,t.select(n[0]));return function(t,n,a){t.$watch("data",function(t,n,a){if(r=a,a.data&&a.data[0]&&a.data[0].value&&a.data[0].value[0]&&!n){var i=a.data[0].value,u=a.data[0].group;e(l,i,u)}else if(a.data&&a.data[0]&&a.data[0].value&&a.data[0].value[0]&&JSON.stringify(t[0].value[0].title?t[0].value[0].title:t)!=JSON.stringify(n[0].value[0]?n[0].value[0].title:n)){var i=a.data[0].value,u=a.data[0].group;e(l,i,u)}},!0)}}}}]);