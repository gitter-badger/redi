"use strict";var genericCloud=angular.module("genericCloud",[]);genericCloud.factory("d3",function(){return d3}),genericCloud.directive("genericCloud",["d3","globalData","sparqlQuery",function(t,e,n){var r,a,i,u,c,l,o,s,d,f,b,p,h,g,v,m,x,y,w,R,C,U,I,E,D,O,T,A,N,P,j,k,q;o=[],R=null,g=null,v={top:5,right:0,bottom:0,left:0},m=50,C=t.scale.sqrt().range([0,m]),U=function(t){return parseInt(t.value)},p=function(t){return t.label},I=function(t){return t.label},c=10,x=12,h=.1,D=function(t){return t.forEach(function(t){t.value=parseInt(t.value)}),t},E=function(t){var e;return e=.1*t.alpha,R.each(d(e)).each(u(h)).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),g.style("left",function(t){return 17+(v.left+t.x)-t.dx/2+"px"}).style("top",function(t){return 140+(v.top+t.y)-t.dy/2+"px"})},r=function(e){return e.each(function(e){var n,r,i;return o=D(e),n=t.max(o,function(t){return U(t)}),C.domain([0,n]),r=t.select(this).selectAll("svg").data([o]),i=r.enter().append("svg"),r.attr("width",P+v.left+v.right),r.attr("height",b+v.top+v.bottom),R=i.append("g").attr("id","gbubble-nodes").attr("transform","translate("+v.left+","+v.top+")"),R.append("rect").attr("id","gbubble-background").attr("width",P).attr("height",b).on("click",a),g=t.select(this).selectAll("#gbubble-labels").data([o]).enter().append("div").attr("id","gbubble-labels"),O(),t.select(window)})},O=function(){return o.forEach(function(t,e){return t.forceR=Math.max(x,C(U(t>50?50:t)))}),s.nodes(o).start(),N(),A()},N=function(){return R=R.selectAll(".gbubble-node").data(o,function(t){return p(t)}),R.exit().remove(),R.enter().append("a").attr("class","gbubble-node").attr("xlink:href",function(t){return"#"+encodeURIComponent(p(t))}).call(s.drag).call(l).append("circle").attr("id","gcircle").attr("r",function(t){return C(U(t>50?50:t))})},A=function(){var t;return g=g.selectAll(".gbubble-label").data(o,function(t){return p(t)}),g.exit().remove(),t=g.enter().append("a").attr("class","gbubble-label").attr("href",function(t){return"#"+encodeURIComponent(p(t))}).call(s.drag).call(l),t.append("div").attr("class","gbubble-label-name").text(function(t){return I(t)}),t.append("div").attr("class","gbubble-label-value").text(function(t){return U(t)}),g.style("font-size",function(t){return Math.max(8,C(U(t>50?50:t)/3.5))+"px"}).style("width",function(t){return.1*C(U(t))+"px"}),g.append("span").text(function(t){return I(t)}).each(function(t){return t.dx=Math.max(2.5*C(U(t)),this.getBoundingClientRect().width)}).remove(),g.style("width",function(t){return t.dx+"px"}),g.each(function(t){return t.dy=this.getBoundingClientRect().height})},d=function(t){var e,n,r,a;return r=P/2,a=b/2,e=t/8,n=t,function(t){return t.x+=(r-t.x)*e,t.y+=(a-t.y)*n}},u=function(t){return function(e){return o.forEach(function(n){var r,a,i,u,l,o;if(e!==n&&(l=e.x-n.x,o=e.y-n.y,r=Math.sqrt(l*l+o*o),a=e.forceR+n.forceR+c,r<a))return r=(r-a)/r*t,i=l*r,u=o*r,e.x-=i,e.y-=u,n.x+=i,n.y+=u})}},l=function(t){return t.on("click",i),t.on("mouseover",w),t.on("mouseout",y)},a=function(){return location.replace("#")},i=function(r){var a=$("div.tree-node-info");if(a){var i=r.label,u=$("div.head-info");u.find("title").text("ddddddtitletitle"),u.html(""),j.$parent.exportReport(r.id);var c=$("<div>"),l=$('<span class="label label-primary" style="font-size:35px">').text("PUBLICATIONS OF : "+r.label);c.append(l),c.append("</br>"),u.append(c);var o=e.PREFIX+" CONSTRUCT { ?subject uc:publication ?publicationUri.  ?publicationUri a bibo:Document.  ?publicationUri dct:title ?title.  ?publicationUri bibo:abstract ?abstract.  ?publicationUri bibo:uri ?uri.  }  WHERE { GRAPH <"+e.centralGraph+"> { ?subject foaf:name ?name FILTER (mm:fulltext-search(str(?name),'"+i+"')) ?subject foaf:publications ?publicationUri.  ?publicationUri dct:title ?title .   OPTIONAL { ?publicationUri bibo:abstract  ?abstract.  }  OPTIONAL { ?publicationUri bibo:uri  ?uri.  }  }}  ORDER BY DESC(?abstract)";waitingDialog.show("Searching Publications of: "+i),n.querySrv({query:o},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e){var n=e["@graph"];n.sort(function(t,e){return t-e});var r=_.where(n,{"@type":"bibo:Document"}),a=r.length?r:[r];j.ctrlFn({value:a}),waitingDialog.hide()}else waitingDialog.hide()})})}return t.event.preventDefault()},f=function(){var t;return t=decodeURIComponent(location.hash.substring(1)).trim(),T(t)},T=function(e){return R.classed("gbubble-selected",function(t){return e===p(t)}),e.length>0?t.select("#status").html('<h3>The word <span class="active">'+e+"</span> is now active</h3>"):t.select("#status").html("<h3>No word is active</h3>")},w=function(t){return R.classed("gbubble-hover",function(e){return e===t})},y=function(t){return R.classed("gbubble-hover",!1)},r.jitter=function(t){return arguments.length?(h=t,s.start(),r):h},r.height=function(t){return arguments.length?(b=t,r):b},r.width=function(t){return arguments.length?(P=t,r):P},r.r=function(t){return arguments.length?(U=t,r):U};var F=function(e,n,a,i,u,c,l){P=n,b=a,j=u,k=c,q=l,t.select("div.head-pagetitle").text(q),s=t.layout.force().gravity(0).charge(0).size([P,b]).on("tick",E),e.datum(i).call(r)};return{restrict:"E",scope:{ctrlFn:"&",data:"="},compile:function(e,n,r){var a=parseInt(e.css("width")),i=parseInt(e.css("height")),u=n.ctWidth?n.ctWidth:a,c=n.ctHeight?n.ctHeight:i,l=t.select(e[0]);return function(t,e,n){t.$watch("data",function(t,e,r){var a=r.data;if(a){var i=a.data,o=a.schema,s=o.fields,d=[];_.each(i["@graph"],function(t,e){if(t["rdfs:label"]){var n=t[s[1]]["@value"]>50?"+50":t[s[1]]["@value"],r="string"==typeof t[s[0]]?t[s[0]]:_(t[s[0]]).first();d.push({id:t["@id"],label:r,value:n})}});var f="";f=_.findWhere(i["@graph"],{"@type":"uc:pagetitle"})["uc:viewtitle"],F(l,u,c,d,r,n,f)}},!0)}}}}]);