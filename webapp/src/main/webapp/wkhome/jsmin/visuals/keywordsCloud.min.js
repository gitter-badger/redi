"use strict";var pieChart=angular.module("cloudTag",[]);pieChart.factory("d3",function(){return d3}),pieChart.directive("cloudTag",["$routeParams","d3","globalData","sparqlQuery",function(t,e,a,n){function r(t,e){var r=t;n.querySrv({query:r},function(t){jsonld.compact(t,a.CONTEXT,function(t,a){if(a){var n=a["@graph"];if(n){var r=$("div.tree-node-author-info ."+e);r.html("");var u=n.length?n:[n];r.append('<h4 style="padding: 20px" class="totalauthors text-success"> Autores: '+(u.length-1)+"</h4>");var i=$("<div>");r.append(i),_.map(u,function(t){if(t["rdfs:label"]&&t["uc:total"]["@value"]){var e=$("<a class='relatedauthors' target='blank' onclick = 'clickonRelatedauthor(\""+t["@id"]+"\")'  >").text(""),a="string"==typeof t["rdfs:label"]?t["rdfs:label"]:_(t["rdfs:label"]).first();return e.append(a+"("+t["uc:total"]["@value"]+")"),i.append(e),i.append("</br>"),e}})}waitingDialog.hide()}waitingDialog.hide()})})}function u(t){var e=t.label;if(e){var a=String.format(q,e,e);r(a,"authorsByPublications")}}var i,c,l,o,s,b,d,f,p,h,g,v,m,y,x,E,R,T,w,k,I,C,S,U,j,A,P,N,O,D,L,H,q=(a.PREFIX+' CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}"  .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   }   WHERE {   {  SELECT DISTINCT  ?subject ?name (count(?pub) as ?totalPub) WHERE {    GRAPH <'+a.clustersGraph+">          {                  ?cluster <http://ucuenca.edu.ec/resource/hasPerson> <{1}> .                 ?cluster <http://ucuenca.edu.ec/resource/hasPerson> ?subject.                 ?subject foaf:publications ?pub                 {                     SELECT ?name                     {                         graph <"+a.centralGraph+">                         {                             ?subject foaf:name ?name.                         }                     }             }         }      } group by ?subject ?name           }}    ",a.PREFIX+'  CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}" .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   }   WHERE {   {      SELECT ?subject (count(DISTINCT(?publicationUri)) as ?totalPub) ?name          WHERE {              GRAPH <'+a.centralGraph+'> {              ?subject foaf:publications ?publicationUri.              ?publicationUri dcterms:subject ?keySub .             ?keySub rdfs:label ?quote.              FILTER (mm:fulltext-search(?quote, "{1}" )) .             ?subject foaf:name ?name.  }              }          GROUP BY ?subject ?name   }  } LIMIT 100');d=[],k=null,y=null,x={top:5,right:0,bottom:0,left:0},E=55,I=e.scale.sqrt().range([0,E]),C=function(t){return parseInt(t.value)},v=function(t){return t.label},S=function(t){return t.label},s=10,R=3,m=.01,j=function(t){return t.forEach(function(t){t.value=parseInt(t.value)}),t},U=function(t){var e;return e=.01*t.alpha,k.each(p(e)).each(o(m)).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),y.style("left",function(t){return 17+(x.left+t.x)-t.dx/2+"px"}).style("top",function(t){return 50+(x.top+t.y)-t.dy/2+"px"})},i=function(t){return t.each(function(t){var a,n,r;return d=j(t),a=e.max(d,function(t){return C(t)}),I.domain([0,a]),n=e.select(this).selectAll("svg").data([d]),r=n.enter().append("svg"),n.attr("width",D+x.left+x.right),n.attr("height",g+x.top+x.bottom),k=r.append("g").attr("id","bubble-nodes").attr("transform","translate("+x.left+","+x.top+")"),k.append("rect").attr("id","bubble-background").attr("width",D).attr("height",g).on("click",c),y=e.select(this).selectAll("#bubble-labels").data([d]).enter().append("div").attr("id","bubble-labels"),A(),e.select(window)})},A=function(){return d.forEach(function(t,e){return t.forceR=Math.max(R,I(C(t)))}),f.nodes(d).start(),O(),N()},O=function(){return k=k.selectAll(".bubble-node").data(d,function(t){return v(t)}),k.exit().remove(),k.enter().append("a").attr("class","bubble-node").attr("xlink:href",function(t){return"#"+encodeURIComponent(v(t))}).call(f.drag).call(b).append("circle").attr("id","kcircle").attr("r",function(t){return I(C(t))})},N=function(){var t;return y=y.selectAll(".bubble-label").data(d,function(t){return v(t)}),y.exit().remove(),t=y.enter().append("a").attr("class","bubble-label"),t.append("div").attr("class","bubble-label-name").text(function(t){return S(t)}).call(b),t.append("div").attr("class","bubble-label-value").text(function(t){return C(t)}),y.style("font-size",function(t){return Math.max(9,I(C(t)/5))+"px"}).style("width",function(t){return.1*I(C(t))+"px"}),y.append("span").text(function(t){return S(t)}).each(function(t){return t.dx=Math.max(2.5*I(C(t)),this.getBoundingClientRect().width)}).remove(),y.style("width",function(t){return t.dx+"px"}),y.each(function(t){return t.dy=(Number(this.getBoundingClientRect().height)-110).toString()})},p=function(t){var e,a,n,r;return n=D/2,r=g/2,e=t/8,a=t,function(t){return t.x+=(n-t.x)*e,t.y+=(r-t.y)*a}},o=function(t){return function(e){return d.forEach(function(a){var n,r,u,i,c,l;if(e!==a&&(c=e.x-a.x,l=e.y-a.y,n=Math.sqrt(c*c+l*l),r=e.forceR+a.forceR+s,n<r))return n=(n-r)/n*t,u=c*n,i=l*n,e.x-=u,e.y-=i,a.x+=u,a.y+=i})}},b=function(t){return t.on("click",l),t.on("mouseover",w),t.on("mouseout",T)},c=function(){return location.replace("#")},l=function(r){u(r);var i=$("div.tree-node-info");if(i){var c=r.label,l=$("div.head-info");l.find("title").text("ddddddtitletitle"),l.html(""),L.$parent.exportReport(c);var o,s=$("<div>");o="es"===t.lang?$('<span class="label label-primary" style="font-size:35px; background-color: #003769; opacity: 0.8;">').text("PUBLICACIONES Y AUTORES RELACIONADOS CON: "+c):$('<span class="label label-primary" style="font-size:35px; background-color: #003769; opacity: 0.8;">').text("PUBLICATIONS AND AUTHORS RELATED WITH: "+c),s.append(o),s.append("</br>"),l.append(s);var b=a.PREFIX+" CONSTRUCT { ?keyword uc:publication ?publicationUri.  ?publicationUri dct:contributors ?subject .  ?subject foaf:name ?name .  ?subject a foaf:Person .  ?publicationUri a bibo:Document.  ?publicationUri dct:title ?title.  ?publicationUri bibo:abstract ?abstract.  ?publicationUri bibo:uri ?uri.  }  WHERE { GRAPH <"+a.centralGraph+'> { ?subject foaf:publications ?publicationUri . ?subject foaf:name ?name . ?publicationUri dct:title ?title .  OPTIONAL{ ?publicationUri bibo:abstract  ?abstract. }  OPTIONAL{ ?publicationUri bibo:uri  ?uri. }  ?publicationUri dcterms:subject ?keySub.  ?keySub rdfs:label ?quote.  FILTER (mm:fulltext-search(?quote, "'+c+'" )) .  BIND(REPLACE( "'+c+'", " ", "_", "i") AS ?key) .  BIND(IRI(?key) as ?keyword) }}';waitingDialog.show("Searching publications with the keyword: "+c),n.querySrv({query:b},function(t){jsonld.compact(t,a.CONTEXT,function(t,e){if(waitingDialog.show("Searching publications with the keyword: "+c),e){var a=e["@graph"],n=a;n.length?n:[n];L.ctrlFn({value:a}),waitingDialog.hide()}else waitingDialog.hide()})})}return e.event.preventDefault()},h=function(){var t;return t=decodeURIComponent(location.hash.substring(1)).trim(),P(t)},P=function(t){return k.classed("bubble-selected",function(e){return t===v(e)}),t.length>0?e.select("#status").html('<h3>The word <span class="active">'+t+"</span> is now active</h3>"):e.select("#status").html("<h3>No word is active</h3>")},w=function(t){return k.classed("bubble-hover",function(e){return e===t})},T=function(t){return k.classed("bubble-hover",!1)},i.jitter=function(t){return arguments.length?(m=t,f.start(),i):m},i.height=function(t){return arguments.length?(g=t,i):g},i.width=function(t){return arguments.length?(D=t,i):D},i.r=function(t){return arguments.length?(C=t,i):C};var W=function(t,a,n,r,u,c){var l=t;l.html(""),D=a,g=n,L=u,H=c,f=e.layout.force().gravity(0).charge(0).size([D,g]).on("tick",U),t.datum(r).call(i)};return{restrict:"E",scope:{ctrlFn:"&",data:"="},compile:function(t,a,n){var r=parseInt(t.css("width")),u=parseInt(t.css("height")),i=a.ctWidth?a.ctWidth:r,c=a.ctHeight?a.ctHeight:u,l=e.select(t[0]);return function(t,e,a){t.$watch("data",function(t,e,n){var r=n.data;if(r){var u=r.data,o=r.schema,s=o.fields,b=[];_.each(u["@graph"],function(t,e){b.push({label:t[s[0]],value:t[s[1]]["@value"]})}),W(l,i,c,b,n,a)}},!0)}}}}]);