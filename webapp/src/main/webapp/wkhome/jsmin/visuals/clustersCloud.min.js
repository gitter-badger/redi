"use strict";var clusterKeywCloud=angular.module("clusterKeywCloud",[]);clusterKeywCloud.factory("d3",function(){return d3}),clusterKeywCloud.directive("clusterKeywCloud",["d3","globalData","sparqlQuery",function(t,e,n){function r(){$(".popover").each(function(){$(this).remove()})}function a(t){$(this).popover({placement:"auto top",container:"body",trigger:"manual",html:!0,content:function(){return null!=t["abstract"]&&(t["abstract"].constructor===Array||t["abstract"]instanceof Array)&&(t["abstract"]=t["abstract"][0]),"<strong>Cluster:</strong> "+t.label+"<br /><strong>Authors</strong> in this cluster with publications that contain "+F.toString().replace("Clusters that contain ","").replace(' Keyword".',"").replace("Clusters que contienen ","")}}),$(this).popover("show")}var u,c,i,l,o,s,d,f,h,p,b,g,v,y,m,w,x,C,j,T,k,R,S,E,I,A,D,U,q,K,N,W,F="";d=[],T=null,y=null,m={top:5,right:0,bottom:0,left:0},w=35,k=t.scale.sqrt().range([0,w]),R=function(t){return parseInt(t.value)},g=function(t){return t.label},S=function(t){return t.label},o=10,x=12,v=.1,I=function(t){return t.forEach(function(t){t.value=parseInt(t.value)}),t},E=function(t){var e;return e=.1*t.alpha,T.each(h(e)).each(l(v)).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),y.style("left",function(t){return 17+(m.left+t.x)-t.dx/2+"px"}).style("top",function(t){return 140+(m.top+t.y)-t.dy/2+"px"})},u=function(e){return e.each(function(e){var n,r,a;return d=I(e),n=t.max(d,function(t){return R(t)}),k.domain([0,n]),r=t.select(this).selectAll("svg").data([d]),a=r.enter().append("svg"),r.attr("width",K+m.left+m.right),r.attr("height",b+m.top+m.bottom),T=a.append("g").attr("id","gbubble-nodes").attr("transform","translate("+m.left+","+m.top+")"),T.append("rect").attr("id","gbubble-background").attr("width",K).attr("height",b),y=t.select(this).selectAll("#gbubble-labels").data([d]).enter().append("div").attr("id","gbubble-labels"),A(),t.select(window)})},A=function(){return d.forEach(function(t,e){return t.forceR=Math.max(x,k(R(t)))}),f.nodes(d).start(),q(),U()},q=function(){return T=T.selectAll(".gbubble-node").data(d,function(t){return g(t)}),T.exit().remove(),T.enter().append("a").attr("class","gbubble-node").call(f.drag).call(s).append("circle").attr("id","gcircle").attr("r",function(t){return k(R(t))})},U=function(){var t;return y=y.selectAll(".gbubble-label").data(d,function(t){return g(t)}),y.exit().remove(),t=y.enter().append("a").attr("class","gbubble-label").call(f.drag).call(s),t.append("div").attr("class","gbubble-label-name").text(function(t){return S(t)}),t.append("div").attr("class","gbubble-label-value").text(function(t){return R(t)}),y.style("font-size",function(t){return Math.max(8,k(R(t)/5))+"px"}).style("width",function(t){return.1*k(R(t))+"px"}),y.append("span").text(function(t){return S(t)}).each(function(t){return t.dx=Math.max(2.5*k(R(t)),this.getBoundingClientRect().width)}).remove(),y.style("width",function(t){return t.dx+"px"}),y.each(function(t){return t.dy=this.getBoundingClientRect().height})},h=function(t){var e,n,r,a;return r=K/2,a=b/2,e=t/8,n=t,function(t){return t.x+=(r-t.x)*e,t.y+=(a-t.y)*n}},l=function(t){return function(e){return d.forEach(function(n){var r,a,u,c,i,l;if(e!==n&&(i=e.x-n.x,l=e.y-n.y,r=Math.sqrt(i*i+l*l),a=e.forceR+n.forceR+o,r<a))return r=(r-a)/r*t,u=i*r,c=l*r,e.x-=u,e.y-=c,n.x+=u,n.y+=c})}},s=function(t){return t.on("click",i),t.on("mouseover",j),t.on("mouseout",C)},c=function(){return location.replace("#")},i=function(r){var a=$("div.tree-node-info");if(a){var u=r.label,c=$("div.head-info");c.find("title").text("ddddddtitletitle"),c.html(""),N.$parent.exportReport(r.id);var i=$("<div>"),l=$('<span class="label label-primary" style="font-size:35px">').text("AUTHORS OF CLUSTER "+r.label);i.append(l),i.append("</br>"),c.append(i);var o=e.PREFIX+"CONSTRUCT {     ?subject a foaf:Person. \t?subject foaf:name ?name. \t?subject dcterms:subject ?keywords. } where{ SELECT DISTINCT ?subject ?name ?keywords WHERE  {     graph <"+e.clustersGraph+">           {               <"+r.id+">  uc:hasPerson  ?subject.     {      \t\t\t       select DISTINCT ?subject ?name ?keywords            \t\t       where            \t\t                     {            \t                       graph <"+e.centralGraph+">            \t\t\t                             {            \t\t\t\t                                 ?subject foaf:name ?name.                               ?subject foaf:publications ?publicationUri.  \t\t\t\t\t\t\t  ?publicationUri dct:title ?title .                           ?publicationUri dcterms:subject ?keySub.                           ?keySub rdfs:label ?keywords.                          }          \t\t\t                 } group by ?subject ?name ?keywords         \t }            }  }  } ";waitingDialog.show("Searching Authors of the cluster "+u),n.querySrv({query:o},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e){var n=[];_.map(e["@graph"],function(t){for(var e,r=0;r<20&&r<t["dcterms:subject"].length;r++)e=(e?e+", ":"")+t["dcterms:subject"][r];n.push({"@id":t["@id"],"@type":t["@type"],"dcterms:subject":e,"foaf:name":t["foaf:name"]})});var r=n,a=_.where(r,{"@type":"foaf:Person"}),u=a.length?a:[a];N.ctrlFn({value:u}),waitingDialog.hide()}else waitingDialog.hide()})})}return t.event.preventDefault()},p=function(){var t;return t=decodeURIComponent(location.hash.substring(1)).trim(),D(t)},D=function(e){return T.classed("gbubble-selected",function(t){return e===g(t)}),e.length>0?t.select("#status").html('<h3>The word <span class="active">'+e+"</span> is now active</h3>"):t.select("#status").html("<h3>No word is active</h3>")},j=function(t){return a.call(this,t),T.classed("gbubble-hover",function(e){return e===t})},C=function(t){return r(),T.classed("gbubble-hover",!1)},u.jitter=function(t){return arguments.length?(v=t,f.start(),u):v},u.height=function(t){return arguments.length?(b=t,u):b},u.width=function(t){return arguments.length?(K=t,u):K},u.r=function(t){return arguments.length?(R=t,u):R};var H=function(e,n,r,a,c,i,l){K=n,b=r,N=c,W=i,F=l,t.select("div.head-pagetitle").text(F),f=t.layout.force().gravity(0).charge(0).size([K,b]).on("tick",E),e.datum(a).call(u)};return{restrict:"E",scope:{ctrlFn:"&",data:"="},compile:function(e,n,r){var a=parseInt(e.css("width")),u=parseInt(e.css("height")),c=n.ctWidth?n.ctWidth:a,i=n.ctHeight?n.ctHeight:u,l=t.select(e[0]);return function(t,e,n){t.$watch("data",function(t,e,r){var a=r.data;if(a){var u=a.data,o=a.schema,s=o.fields,d=[];_.each(u["@graph"],function(t,e){if(t["rdfs:label"]){var n=t["@id"],r=s[1].replace("uc:","http://ucuenca.edu.ec/ontology#"),a="";(t[s[1]]||t[r])&&(a=t[s[1]]?t[s[1]]["@value"]:t[r]["@value"]),"uc:resulttitle"!=t[s[0]].toString().toLowerCase()&&"http://ucuenca.edu.ec/wkhuska/resource/resultTitle"!=t[s[0]]&&d.push({id:n,label:t[s[0]],value:a})}});try{F=_.findWhere(u["@graph"],{"@type":"uc:pagetitle"})["uc:viewtitle"]}catch(f){F=_.findWhere(u["@graph"],{"@type":"http://ucuenca.edu.ec/resource/pagetitle"})["http://ucuenca.edu.ec/resource/viewtitle"]}H(l,c,i,d,r,n,F)}},!0)}}}}]);