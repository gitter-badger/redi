"use strict";var keywClusters=angular.module("keywClusters",[]);keywClusters.factory("d3",function(){return d3}),keywClusters.directive("keywClusters",["d3","$routeParams","globalData","sparqlQuery",function(t,e,n,r){var a,u,l,c,i,o,s,f,d,h,b,p,g,v,y,m,w,x,C,k,T,E,I,R,S,D,N,j,q,A,H;o=[],C=null,g=null,v={top:5,right:0,bottom:0,left:0},y=35,k=t.scale.sqrt().range([0,y]),T=function(t){return parseInt(t.value)},b=function(t){return t.label},E=function(t){return t.label},c=2,m=3,p=.08,R=function(t){return t.forEach(function(t){t.value=parseInt(t.value)}),t},I=function(t){var e;return e=.01*t.alpha,C.each(f(e)).each(l(p)).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),g.style("left",function(t){return 17+(v.left+t.x)-t.dx/2+"px"}).style("top",function(t){return 50+(v.top+t.y)-t.dy/2+"px"})},a=function(e){return e.each(function(e){var n,r,a;return o=R(e),n=t.max(o,function(t){return T(t)}),n>80&&(n-=80),k.domain([0,n]),r=t.select(this).selectAll("svg").data([o]),a=r.enter().append("svg"),r.attr("width",q+v.left+v.right),r.attr("height",h+v.top+v.bottom),C=a.append("g").attr("id","bubble-nodes").attr("transform","translate("+v.left+","+v.top+")"),C.append("rect").attr("id","bubble-background").attr("width",q).attr("height",h),g=t.select(this).selectAll("#bubble-labels").data([o]).enter().append("div").attr("id","bubble-labels"),S(),t.select(window)})},S=function(){return o.forEach(function(t,e){return t.forceR=Math.max(m,k(T(t)))}),s.nodes(o).start(),j(),N()},j=function(){return C=C.selectAll(".bubble-node").data(o,function(t){return b(t)}),C.exit().remove(),C.enter().append("a").attr("class","bubble-node").attr("xlink:href",function(t){return"#/"+e.lang+"/cloud/keywords"}).call(s.drag).call(i).append("circle").attr("id","kcircle").attr("r",function(t){return k(T(t))})},N=function(){var t;return g=g.selectAll(".bubble-label").data(o,function(t){return b(t)}),g.exit().remove(),t=g.enter().append("a").attr("class","bubble-label").call(s.drag).call(i),t.append("div").attr("class","bubble-label-name").text(function(t){return E(t)}),t.append("div").attr("class","bubble-label-value").text(function(t){return T(t)}),g.style("font-size",function(t){return Math.max(9,k(T(t)/5))+"px"}).style("width",function(t){return.1*k(T(t))+"px"}),g.append("span").text(function(t){return E(t)}).each(function(t){return t.dx=Math.max(2.5*k(T(t)),this.getBoundingClientRect().width)}).remove(),g.style("width",function(t){return t.dx+"px"}),g.each(function(t){return t.dy=(Number(this.getBoundingClientRect().height)-10).toString()})},f=function(t){var e,n,r,a;return r=q/2,a=h/2,e=t/8,n=t,function(t){return t.x+=(r-t.x)*e,t.y+=(a-t.y)*n}},l=function(t){return function(e){return o.forEach(function(n){var r,a,u,l,i,o;if(e!==n&&(i=e.x-n.x,o=e.y-n.y,r=Math.sqrt(i*i+o*o),a=e.forceR+n.forceR+c,r<a))return r=(r-a)/r*t,u=i*r,l=o*r,e.x-=u,e.y-=l,n.x+=u,n.y+=l})}},i=function(t){return t.on("click",u),t.on("mouseover",x),t.on("mouseout",w)},u=function(t){var a="";a="es"===e.lang?"\"Clusters que contienen '"+t.label+"' Keyword\"":"\"Clusters that contain '"+t.label+"' Keyword\"";var u=n.PREFIX+" Construct { uc:resultTitle a uc:pagetitle. uc:resultTitle uc:viewtitle "+a+".  ?cluster rdfs:label ?name. ?cluster uc:total ?totalperson.} WHERE{{SELECT DISTINCT ?cluster ?name (COUNT(DISTINCT ?subject) as ?totalperson)WHERE{  graph <"+n.clustersGraph+">        {          ?cluster uc:hasPerson ?subject.           ?cluster rdfs:label ?name.   \t\t?subject foaf:publications ?pubb.           \t{      \t\t\tselect DISTINCT ?pubb ?title             \t\twhere            \t\t{            \t\t\tgraph <"+n.centralGraph+'>            \t\t\t{            \t\t\t\t?pubb dcterms:subject ?keySub.                                         ?keySub rdfs:label "'+t.label+'".                          \t?pubb dct:title ?title.              \t\t\t}          \t\t\t}          \t}          } }  group by ?cluster ?name         } Filter(?totalperson > 1)}';waitingDialog.show("Loading Authors Related with "+t.label),r.querySrv({query:u},function(t){jsonld.compact(t,n.CONTEXT,function(t,e){if(e["@graph"]){var n=e["@graph"];n.length?n:[n];A.ifClick({value:e}),waitingDialog.hide()}else waitingDialog.hide()})})},d=function(){var t;return t=decodeURIComponent(location.hash.substring(1)).trim(),D(t)},D=function(e){return C.classed("bubble-selected",function(t){return e===b(t)}),e.length>0?t.select("#status").html('<h3>The word <span class="active">'+e+"</span> is now active</h3>"):t.select("#status").html("<h3>No word is active</h3>")},x=function(t){return C.classed("bubble-hover",function(e){return e===t})},w=function(t){return C.classed("bubble-hover",!1)},a.jitter=function(t){return arguments.length?(p=t,s.start(),a):p},a.height=function(t){return arguments.length?(h=t,a):h},a.width=function(t){return arguments.length?(q=t,a):q},a.r=function(t){return arguments.length?(T=t,a):T};var M=function(e,n,r,u,l,c){q=n,h=r,A=l,H=c,s=t.layout.force().gravity(0).charge(0).size([q,h]).on("tick",I),e.datum(u).call(a)};return{restrict:"E",scope:{ifClick:"&",data:"="},compile:function(e,n,r){var a=parseInt(e.css("width")),u=parseInt(e.css("height")),l=n.ctWidth?n.ctWidth:a,c=n.ctHeight?n.ctHeight:u,i=t.select(e[0]);return function(t,e,n){t.$watch("data",function(t,e,r){var a=r.data;if(a){var u=a.data,o=a.schema,s=o.fields,f=[];_.each(u["@graph"],function(t,e){f.push({label:t[s[0]],value:t[s[1]]["@value"]})}),M(i,l,c,f,r,n)}},!0)}}}}]);