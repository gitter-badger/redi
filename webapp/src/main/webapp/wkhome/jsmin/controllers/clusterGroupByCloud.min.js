wkhomeControllers.controller("clusterGroupByCloud",["$timeout","$scope","globalData","sparqlQuery","clustersQuery","searchData","$route","$window","$routeParams",function(e,t,r,a,o,l,u,s,c){function n(){var e=r.PREFIX+" CONSTRUCT { ?keyword rdfs:label ?key } \tFROM <"+r.centralGraph+'>  WHERE {      SELECT  (count(?key) as ?k) ?key      WHERE {          ?subject dcterms:subject ?keywordSubject.          ?keywordSubject rdfs:label ?key.          BIND(REPLACE(?key, " ", "_", "i") AS ?unickey).          BIND(IRI(?unickey) as ?keyword)      }      GROUP BY ?keyword  ?key      HAVING(?k > 10) }';a.querySrv({query:e},function(e){waitingDialog.show(),jsonld.compact(e,r.CONTEXT,function(e,r){_.map(r["@graph"],function(e){var r={};r.id=e["@id"],r.tag=e["rdfs:label"],t.themes.push({tag:r.tag})}),d(),waitingDialog.hide()})})}function d(){t.$apply(function(){t.relatedthemes=t.themes,t.selectedItem=l.researchArea,l.allkeywords=t.themes})}function h(e,t){}function f(t,o){var u=[],s=[];new Array;if(null==l.clustersAuthors||0==l.clustersAuthors.length){l.clustersAuthors=[];var c=r.PREFIX+'CONSTRUCT {?author foaf:name ?name. ?author uc:hasCluster ?clusterId. ?author rdfs:label ?label. ?author dcterms:subject ?keywords }WHERE{   {     SELECT DISTINCT ?author ?name ?clusterId ?label (group_concat(DISTINCT ?keyword; separator = ", ") as ?keywords)     WHERE {      GRAPH <'+r.clustersGraph+"> {         {          SELECT ?clusterId           WHERE{            ?clusterId foaf:publications  ?pub          } GROUP BY ?clusterId            HAVING (COUNT(?pub) > 20)        }        ?clusterId rdfs:label ?label .         ?clusterId foaf:publications  ?publication .         ?publication uc:hasPerson ?author .        {          SELECT * {            GRAPH <"+r.centralGraph+"> {                ?author foaf:name ?name .                ?publication dcterms:subject ?keywordSubject.                 ?keywordSubject rdfs:label ?keyword.             }          }         }      }     }     GROUP BY ?author ?name ?clusterId ?label  } }";a.querySrv({query:c},function(t){jsonld.compact(t,r.CONTEXT,function(t,r){_.map(r["@graph"],function(e){var t={},r=e["uc:hasCluster"],a="";if(a=e["dct:subject"],null!=r&&(r.constructor===Array||r instanceof Array))for(i=0;i<r.length;i++)t.IdAuthor=e["@id"],t.IdCluster=e["uc:hasCluster"][i]["@id"],t.ClusterName=e["rdfs:label"][i],t.Author=e["foaf:name"],t.Keyword=a[i],t.Title=e["foaf:name"],t.URI=e["foaf:name"],s.push({idAuthor:t.IdAuthor,cluster:t.IdCluster,clusterName:t.ClusterName,author:t.Author,keyword:t.Keyword,title:t.Title,uri:t.URI});else t.IdAuthor=e["@id"],t.IdCluster=e["uc:hasCluster"]["@id"],t.ClusterName=e["rdfs:label"],t.Author=e["foaf:name"],t.Keyword=a,t.Title=e["foaf:name"],t.URI=e["foaf:name"],s.push({idAuthor:t.IdAuthor,cluster:t.IdCluster,clusterName:t.ClusterName,author:t.Author,keyword:t.Keyword,title:t.Title,uri:t.URI})});var a=new Array;for(i=0,len=s.length;i<len;i++)null==a[s[i].cluster.toString()]&&(a[s[i].cluster.toString()]=new Array,a[s[i].cluster.toString()][0]=1,a[s[i].cluster.toString()][1]=0),a[s[i].cluster.toString()][0]=a[s[i].cluster.toString()][0]+1;for(i=0,len=s.length;i<len;i++)a[s[i].cluster.toString()][0]>4&&a[s[i].cluster.toString()][1]<95&&(u.push(s[i]),a[s[i].cluster.toString()][1]+=1);l.clustersAuthors=u,e(m(l.clustersAuthors,o)),l.areaSearch=null})})}else e(m(l.clustersAuthors,o)),l.areaSearch=null}function m(r,a){e(function(){t.data=[{value:r,group:a}],t.dataaux=r})}$("html,body").animate({scrollTop:$("#scrollToTop").offset().top},"slow"),t.gbselectedItem="cluster",t.$watch("searchData.areaSearch",function(e,r,a){if(l.areaSearch){var o=l.areaSearch["@graph"];if(o){var u=_.map(o,function(e){var t={};return t.id=e["@id"],t.label=e["rdfs:label"],t});t.candidates=u,t.selectedAuthor=function(e,r){$("#searchResults").modal("hide"),l.researchArea=r,t.selectedItem=r},waitingDialog.hide(),$("#searchResults").modal("show")}else alert("Information not found"),s.location.hash="/",waitingDialog.hide()}},!0),l.allkeywords?(t.relatedthemes=l.allkeywords,t.selectedItem=l.researchArea):(t.themes=[],waitingDialog.show(),n()),t.$watch("gbselectedItem",function(){h(t.dataaux,t.gbselectedItem)}),t.$watch("selectedItem",function(){f(t.selectedItem,t.gbselectedItem)}),t.clickonAuthor=function(e){clickonRelatedauthor(e)},clickonRelatedauthor=function(e){var o=r.PREFIX+" CONSTRUCT {   <"+e+"> foaf:name ?name; a foaf:Person   }    WHERE  {Graph <"+r.centralGraph+">{     <"+e+"> a foaf:Person.     <"+e+"> foaf:name ?name } }";a.querySrv({query:o},function(a){jsonld.compact(a,r.CONTEXT,function(r,a){t.$apply(function(){l.authorSearch=a,s.location.hash="/"+c.lang+"/w/search?"+e})})})}}]);